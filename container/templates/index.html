<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <title>Generador d'Informes Fotogràfics</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: #708090;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px 0
        }

        .container {
            width: 90%;
            max-width: 600px;
            padding: 30px;
            background: rgba(0, 0, 0, .2);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, .3);
            border: 1px solid rgba(255, 255, 255, .1)
        }

        h1 {
            text-align: center;
            margin-top: 0;
            font-weight: 600
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px
        }

        .form-group {
            display: flex;
            flex-direction: column
        }

        .full-width {
            grid-column: 1 / -1
        }

        label {
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center
        }

        input[type=text],
        input[type=file] {
            background-color: #536878;
            color: #fff;
            border: 1px solid #98a9b9;
            padding: 12px;
            border-radius: 6px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box
        }

        input[type=text]:focus {
            outline: 0;
            border-color: #fff
        }

        input[type=file]::-webkit-file-upload-button {
            background-color: #f6f8fa;
            color: #24292e;
            border: none;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px
        }

        button[type=submit] {
            grid-column: 1 / -1;
            padding: 14px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #28a745;
            color: #fff;
            transition: background-color .2s
        }

        button[type=submit]:hover {
            background-color: #218838
        }

        .radio-group {
            background-color: #536878;
            border-radius: 6px;
            padding: 5px;
            display: flex;
            justify-content: space-around
        }

        .radio-group input[type=radio] {
            display: none
        }

        .radio-group label {
            position: relative;
            flex: 1;
            text-align: center;
            padding: 10px 30px 10px 10px;
            margin: 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color .2s
        }

        .radio-group input[type=radio]:checked+label {
            background-color: #708090;
            font-weight: 700
        }

        .status-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%) scale(.5);
            width: 20px;
            height: 20px;
            opacity: 0;
            transition: all .2s ease-in-out
        }

        .status-icon.valid {
            opacity: 1;
            transform: translateY(-50%) scale(1)
        }

        .status-icon.valid::after,
        .status-icon.valid::before {
            content: '';
            position: absolute;
            background-color: #28a745;
            border-radius: 2px
        }

        .status-icon.valid::before {
            width: 3px;
            height: 10px;
            left: 5px;
            top: 7px;
            transform: rotate(-45deg)
        }

        .status-icon.valid::after {
            width: 3px;
            height: 16px;
            left: 11px;
            top: 1px;
            transform: rotate(45deg)
        }

        #overlay {
            position: fixed;
            display: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, .85);
            z-index: 9999;
            cursor: wait;
            flex-direction: column;
            justify-content: center;
            align-items: center
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #28a745;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg)
            }

            100% {
                transform: rotate(360deg)
            }
        }
    </style>
</head>

<body>
    <div id="overlay">
        <div class="loader"></div>
        <div style="font-size:20px;text-align:center;padding:0 20px">Pujant i analitzant imatges...<br><span
                style="font-size:14px;opacity:.8">Això pot trigar uns segons depenent de la quantitat de fotos.</span>
        </div>
    </div>
    <div class="container">
        <!-- Logo Removed as per user request -->
        <h1>Informe Fotogràfic</h1>
        <p style="text-align:center;margin:-10px 0 15px;font-size:12px;opacity:.6">v{{ app_version }} @5085</p>

        <form action="/upload" method="post" enctype="multipart/form-data">
            <div class="form-grid">
                <div class="form-group"><label for="nat">NAT</label>
                    <div class="input-wrapper"><input type="text" id="nat" name="nat" placeholder="Ex: 2435/2025"
                            class="validate-me"><span class="status-icon"></span></div>
                </div>
                <div class="form-group"><label for="dil">Núm. Diligència</label>
                    <div class="input-wrapper"><input type="text" id="dil" name="dil" placeholder="Ex: 12345"
                            class="validate-me"><span class="status-icon"></span></div>
                </div>
                <div class="form-group"><label for="tip1">TIP Agent 1</label>
                    <div class="input-wrapper"><input type="text" id="tip1" name="tip1" placeholder="Ex: 54321"
                            class="validate-me"><span class="status-icon"></span></div>
                </div>
                <div class="form-group"><label for="tip2">TIP Agent 2 (Opcional)</label>
                    <div class="input-wrapper"><input type="text" id="tip2" name="tip2" placeholder="Ex: 98765"
                            class="validate-me"><span class="status-icon"></span></div>
                </div>
                <div class="form-group full-width"><label for="jutjat">Jutjat de destinació</label>
                    <div class="input-wrapper"><input type="text" id="jutjat" name="jutjat"
                            placeholder="Ex: Jutjat d'Instrucció núm. 3" class="validate-me"><span
                            class="status-icon"></span></div>
                </div>
                <div class="form-group full-width"><label for="localitat">Localitat del Jutjat</label>
                    <div class="input-wrapper"><input type="text" id="localitat" name="localitat"
                            placeholder="Ex: Mataró" class="validate-me"><span class="status-icon"></span></div>
                </div>
                <div class="form-group full-width"><label>Destinació</label>
                    <div class="radio-group"><input type="radio" id="qualitat_atenea" name="qualitat" value="atenea"
                            class="validate-radio" checked><label for="qualitat_atenea">Unitat d'Investigació
                            d'Accidents<span class="status-icon"></span></label><input type="radio" id="qualitat_vector"
                            name="qualitat" value="vector" class="validate-radio"><label for="qualitat_vector">Unitat
                            d'Atestats de Trànsit<span class="status-icon"></span></label></div>
                </div>
                <div class="form-group full-width"><label for="photos">Selecciona les fotografies</label>
                    <div class="input-wrapper"><input type="file" id="photos" name="photos" multiple required
                            class="validate-me"><span class="status-icon"></span></div>
                </div>
                <button type="submit">Pujar Imatges i Continuar</button>
            </div>
        </form>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const t = document.querySelectorAll(".validate-me"), e = t => { const e = t.closest(".input-wrapper"); if (!e) return; const a = e.querySelector(".status-icon"); if (!a) return; let l = !1; "file" === t.type ? t.files.length > 0 && (l = !0) : "" !== t.value.trim() && (l = !0), a.classList.toggle("valid", l) };
            t.forEach(t => { t.addEventListener("input", () => e(t)), t.addEventListener("change", () => e(t)) });
            const a = document.querySelectorAll(".validate-radio"), l = () => { a.forEach(t => { const e = document.querySelector(`label[for="${t.id}"]`), a = e.querySelector(".status-icon"); a.classList.toggle("valid", t.checked) }) };
            a.forEach(t => { t.addEventListener("change", l) }), l();

            async function resizeImage(file, maxWidth, maxHeight) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);
                    img.onload = () => {
                        URL.revokeObjectURL(url);
                        const canvas = document.createElement('canvas');
                        let width = img.width, height = img.height;
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        if (ratio < 1) { width *= ratio; height *= ratio; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            if (!blob) return reject(new Error("Error al comprimir imatge."));
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        }, 'image/jpeg', 0.80); // 80% de qualitat com s'ha demanat
                    };
                    img.onerror = () => {
                        URL.revokeObjectURL(url);
                        reject(new Error("Error al carregar la imatge."));
                    };
                    img.src = url;
                });
            }

            const form = document.querySelector('form');
            form.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const overlay = document.getElementById('overlay');
                const statusText = overlay.querySelector('div:last-child');
                overlay.style.display = 'flex';

                const fileInput = document.getElementById('photos');
                const totalFiles = fileInput.files.length;

                try {
                    // 1. Iniciar sessió (NOMÉS camps de text, sense les fotos originals pesades!)
                    let startRes, sid;
                    const startFormData = new FormData();
                    // Copiar només els camps de text per no pujar les fotos originals aquí
                    form.querySelectorAll('input:not([type="file"]), select, textarea').forEach(input => {
                        if (input.name) startFormData.append(input.name, input.value);
                    });
                    // Afegir destinació (radio buttons)
                    const dest = form.querySelector('input[name="qualitat"]:checked');
                    if (dest) startFormData.append("qualitat", dest.value);

                    try {
                        startRes = await fetch('/start_session', { method: 'POST', body: startFormData });
                    } catch (e) {
                        console.warn("Retrying start_session...");
                        await new Promise(r => setTimeout(r, 2000));
                        startRes = await fetch('/start_session', { method: 'POST', body: startFormData });
                    }

                    if (!startRes.ok) throw new Error("Error connectant al servidor.");
                    const startJson = await startRes.json();
                    sid = startJson.sid;

                    // 2. Pujar fotos SEQÜENCIALMENT (Per màxima estabilitat amb fotos grans i mòbils)
                    const uploadedFiles = [];
                    // Concurrència 1: més lent però no falla mai per memòria o xarxa
                    for (let j = 0; j < totalFiles; j++) {
                        statusText.innerHTML = `Processant foto ${j + 1} de ${totalFiles}...`;
                        let resizedBlob;
                        try {
                            resizedBlob = await resizeImage(fileInput.files[j], 1920, 1080);
                        } catch (resErr) {
                            throw new Error(`Error processant "${fileInput.files[j].name}": ${resErr.message}`);
                        }

                        const uploadFormData = new FormData();
                        uploadFormData.append('photos', resizedBlob, fileInput.files[j].name);

                        statusText.innerHTML = `Pujant foto ${j + 1} de ${totalFiles}...`;
                        const res = await fetch(`/upload?sid=${sid}`, { method: 'POST', body: uploadFormData });
                        if (!res.ok) {
                            const errorData = await res.json().catch(() => ({}));
                            throw new Error(`Error en la foto ${j + 1}: ${errorData.error || res.statusText}`);
                        }

                        const data = await res.json();
                        if (data.filename) uploadedFiles.push(data.filename);
                    }

                    // 3. Finalitzar pujada
                    statusText.innerText = "Finalitzant càrrega...";
                    const finalizeRes = await fetch(`/finalize_upload?sid=${sid}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: uploadedFiles })
                    });
                    if (!finalizeRes.ok) throw new Error("Error finalitzant la sessió.");

                    // 3. Redirigir a la pàgina d'ordenació AMB SID
                    window.location.href = `/order?sid=${sid}`;

                } catch (err) {
                    overlay.style.display = 'none';
                    console.error("DEBUG UPLOAD ERROR:", err);
                    let detail = err.message;
                    if (err.name === 'TypeError' && detail === 'Failed to fetch') {
                        detail = "Error de xarxa o bloqueig de servidor. Revisa si les fotos són massa grans o la connexió.";
                    }
                    alert("S'ha produït un error durant la pujada: " + detail);
                }
            });


        });
    </script>

</body>

</html>