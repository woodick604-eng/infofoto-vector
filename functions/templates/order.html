<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <title>Ordenar fotografies</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;background:#708090}
    .container{max-width:1100px;width:92%;margin:28px auto;padding:22px;background:#fff;color:#333;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    #imgList{list-style:none;padding:0;margin:-10px;display:flex;flex-wrap:wrap}
    #imgList li{position:relative;margin:10px;border:1px solid #d0d7de;padding:6px;cursor:move;box-sizing:border-box;flex:1 0 calc(20% - 20px);max-width:calc(20% - 20px);border-radius:8px}
    #imgList li.sortable-ghost{opacity:.4;background:#c0e8ff}
    #imgList li.sortable-chosen{border-color:#007bff}
    #imgList li img{display:block;width:100%;height:auto;border-radius:6px;pointer-events:none}
    .btns{position:absolute;right:6px;bottom:6px;display:flex;gap:6px}
    .btn{font-size:11px;line-height:1;padding:5px 6px;border-radius:12px;border:0;cursor:pointer;background:rgba(0,0,0,.55);color:#fff;opacity:.8}
    .btn:hover{opacity:1}
    .btn.del{background:rgba(231,76,60,.75)}
    button[type=submit]{margin-top:16px;padding:12px 24px;font-size:16px;background:#007bff;color:#fff;border:none;border-radius:8px;cursor:pointer}
    button[type=submit]:hover{background:#0056b3}
    .meta{color:#444;margin:-4px 0 10px;font-size:14px;line-height:1.5}
    .back-link{font-size:14px;margin-top:10px}
    .back-link a{color:#007bff;text-decoration:none}
  </style>
</head>
<body>
<div class="container">
  <h1>Ordenar fotografies</h1>
  <p class="meta">
    {% if nat or dil %}<strong>{% if nat %}NAT: {{ nat }}{% endif %}{% if nat and dil %} - {% endif %}{% if dil %}DIL: {{ dil }}{% endif %}</strong><br>{% endif %}
    {% if tip1 or tip2 %}<strong>{% if tip1 %}TIP: {{ tip1 }}{% endif %}{% if tip1 and tip2 %} - {% endif %}{% if tip2 %}{{ tip2 }}{% endif %}</strong><br>{% endif %}
    {% if jutjat or localitat %}<strong>Destinació:</strong> {{ jutjat }}{% if localitat %}, {{ localitat }}{% endif %}{% endif %}
  </p>
  <form id="generate-form" action="{{ url_for('generate') }}" method="post">
    <input type="hidden" id="order" name="order">
    <ul id="imgList">
      {% for img in images %}
        <li data-filename="{{ img }}">
          <img src="{{ url_for('uploaded_file', filename=img) }}?ts={{ ts }}" alt="{{ img }}">
          <div class="btns">
            <a class="btn edit-btn" href="{{ url_for('edit', filename=img) }}" title="Editar">✎</a>
            <button type="button" class="btn del" title="Eliminar" onclick="removeImage(this)">✖</button>
          </div>
        </li>
      {% endfor %}
    </ul>
    <button type="submit">Generar informe</button>
  </form>
  <p class="back-link"><a href="{{ url_for('index') }}">Tornar a l'inici</a></p>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("imgList"),e=()=>{const e=[...t.querySelectorAll("li")].map(t=>t.dataset.filename);document.getElementById("order").value=e.join(","),fetch("/update_order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:e})})};new Sortable(t,{animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",onEnd:function(t){e()}}),t.querySelectorAll("li").forEach(t=>{t.addEventListener("dblclick",()=>{const e=t.querySelector("a.edit-btn");e&&(window.location.href=e.href)})}),document.getElementById("generate-form").addEventListener("submit",()=>{const e=[...t.querySelectorAll("li")].map(t=>t.dataset.filename);document.getElementById("order").value=e.join(",")}),t.querySelectorAll("li").length>0&&e()});function removeImage(t){const e=t.closest("li"),o=e.dataset.filename;confirm(`Segur que voleu eliminar ${o}?`)&&fetch(`/delete/${encodeURIComponent(o)}`,{method:"POST"}).then(t=>t.json()).then(o=>{e.remove();const n=document.getElementById("imgList"),r=[...n.querySelectorAll("li")].map(t=>t.dataset.filename);document.getElementById("order").value=r.join(","),fetch("/update_order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:r})})})}
</script>
</body>
</html>